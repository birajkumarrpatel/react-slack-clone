{"ast":null,"code":"import _defineProperty from\"C:/Users/BIRAJ/Desktop/react-slack-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"C:/Users/BIRAJ/Desktop/react-slack-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"C:/Users/BIRAJ/Desktop/react-slack-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"C:/Users/BIRAJ/Desktop/react-slack-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"C:/Users/BIRAJ/Desktop/react-slack-clone/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from\"react\";import uuidv4 from\"uuid/v4\";import firebase from\"../../firebase\";import{Segment,Button,Input}from\"semantic-ui-react\";import{Picker,emojiIndex}from\"emoji-mart\";import\"emoji-mart/css/emoji-mart.css\";import FileModal from\"./FileModal\";import ProgressBar from\"./ProgressBar\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var MessageForm=/*#__PURE__*/function(_React$Component){_inherits(MessageForm,_React$Component);var _super=_createSuper(MessageForm);function MessageForm(){var _this;_classCallCheck(this,MessageForm);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={storageRef:firebase.storage().ref(),typingRef:firebase.database().ref(\"typing\"),uploadTask:null,uploadState:\"\",percentUploaded:0,message:\"\",channel:_this.props.currentChannel,user:_this.props.currentUser,loading:false,errors:[],modal:false,emojiPicker:false};_this.openModal=function(){return _this.setState({modal:true});};_this.closeModal=function(){return _this.setState({modal:false});};_this.handleChange=function(event){_this.setState(_defineProperty({},event.target.name,event.target.value));};_this.handleKeyDown=function(event){if(event.keyCode===13){_this.sendMessage();}var _this$state=_this.state,message=_this$state.message,typingRef=_this$state.typingRef,channel=_this$state.channel,user=_this$state.user;if(message){typingRef.child(channel.id).child(user.uid).set(user.displayName);}else{typingRef.child(channel.id).child(user.uid).remove();}};_this.handleTogglePicker=function(){_this.setState({emojiPicker:!_this.state.emojiPicker});};_this.handleAddEmoji=function(emoji){var oldMessage=_this.state.message;var newMessage=_this.colonToUnicode(\"\".concat(oldMessage,\" \").concat(emoji.colons));_this.setState({message:newMessage,emojiPicker:false});setTimeout(function(){return _this.messageInputRef.focus();},0);};_this.colonToUnicode=function(message){return message.replace(/:[A-Za-z0-9_+-]+:/g,function(x){x=x.replace(/:/g,\"\");var emoji=emojiIndex.emojis[x];if(typeof emoji!==\"undefined\"){var unicode=emoji.native;if(typeof unicode!==\"undefined\"){return unicode;}}x=\":\"+x+\":\";});};_this.createMessage=function(){var fileUrl=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var message={timestamp:firebase.database.ServerValue.TIMESTAMP,user:{id:_this.state.user.uid,name:_this.state.user.displayName,avatar:_this.state.user.photoURL}};if(fileUrl!==null){message[\"image\"]=fileUrl;}else{message[\"content\"]=_this.state.message;}return message;};_this.sendMessage=function(){var getMessagesRef=_this.props.getMessagesRef;var _this$state2=_this.state,message=_this$state2.message,channel=_this$state2.channel,user=_this$state2.user,typingRef=_this$state2.typingRef;if(message){_this.setState({loading:true});getMessagesRef().child(channel.id).push().set(_this.createMessage()).then(function(){_this.setState({loading:false,message:\"\",errors:[]});typingRef.child(channel.id).child(user.uid).remove();}).catch(function(err){console.error(err);_this.setState({loading:false,errors:_this.state.errors.concat(err)});});}else{_this.setState({errors:_this.state.errors.concat({message:\"Add a message\"})});}};_this.getPath=function(){if(_this.props.isPrivateChannel){return\"chat/private/\".concat(_this.state.channel.id);}else{return\"chat/public\";}};_this.uploadFile=function(file,metadata){var pathToUpload=_this.state.channel.id;var ref=_this.props.getMessagesRef();var filePath=\"\".concat(_this.getPath(),\"/\").concat(uuidv4(),\".jpg\");_this.setState({uploadState:\"uploading\",uploadTask:_this.state.storageRef.child(filePath).put(file,metadata)},function(){_this.state.uploadTask.on(\"state_changed\",function(snap){var percentUploaded=Math.round(snap.bytesTransferred/snap.totalBytes*100);_this.setState({percentUploaded:percentUploaded});},function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err),uploadState:\"error\",uploadTask:null});},function(){_this.state.uploadTask.snapshot.ref.getDownloadURL().then(function(downloadUrl){_this.sendFileMessage(downloadUrl,ref,pathToUpload);}).catch(function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err),uploadState:\"error\",uploadTask:null});});});});};_this.sendFileMessage=function(fileUrl,ref,pathToUpload){ref.child(pathToUpload).push().set(_this.createMessage(fileUrl)).then(function(){_this.setState({uploadState:\"done\"});}).catch(function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err)});});};return _this;}_createClass(MessageForm,[{key:\"componentWillUnmount\",value:function componentWillUnmount(){if(this.state.uploadTask!==null){this.state.uploadTask.cancel();this.setState({uploadTask:null});}}},{key:\"render\",value:function render(){var _this2=this;// prettier-ignore\nvar _this$state3=this.state,errors=_this$state3.errors,message=_this$state3.message,loading=_this$state3.loading,modal=_this$state3.modal,uploadState=_this$state3.uploadState,percentUploaded=_this$state3.percentUploaded,emojiPicker=_this$state3.emojiPicker;return/*#__PURE__*/_jsxs(Segment,{className:\"message__form\",children:[emojiPicker&&/*#__PURE__*/_jsx(Picker,{set:\"apple\",onSelect:this.handleAddEmoji,className:\"emojiPIcker\",title:\"Pick your emoji\",emoji:\"point_up\"}),/*#__PURE__*/_jsx(Input,{fluid:true,name:\"message\",onChange:this.handleChange,onKeyDown:this.handleKeyDown,value:message,ref:function ref(node){return _this2.messageInputRef=node;},style:{marginBottom:\"0.7em\"},label:/*#__PURE__*/_jsx(Button,{icon:emojiPicker?\"close\":\"add\",content:emojiPicker?\"close\":null,onClick:this.handleTogglePicker}),labelPosition:\"left\",className:errors.some(function(error){return error.message.includes(\"message\");})?\"error\":\"\",placeholder:\"Write your message\"}),/*#__PURE__*/_jsxs(Button.Group,{icon:true,widths:\"2\",children:[/*#__PURE__*/_jsx(Button,{onClick:this.sendMessage,disabled:loading,color:\"orange\",content:\"Add Reply\",labelPosition:\"left\",icon:\"edit\"}),/*#__PURE__*/_jsx(Button,{color:\"teal\",disabled:uploadState===\"uploading\",onClick:this.openModal,content:\"Upload Media\",labelPosition:\"right\",icon:\"cloud upload\"})]}),/*#__PURE__*/_jsx(FileModal,{modal:modal,closeModal:this.closeModal,uploadFile:this.uploadFile}),/*#__PURE__*/_jsx(ProgressBar,{uploadState:uploadState,percentUploaded:percentUploaded})]});}}]);return MessageForm;}(React.Component);export default MessageForm;","map":{"version":3,"sources":["C:/Users/BIRAJ/Desktop/react-slack-clone/src/components/Messages/MessageForm.js"],"names":["React","uuidv4","firebase","Segment","Button","Input","Picker","emojiIndex","FileModal","ProgressBar","MessageForm","state","storageRef","storage","ref","typingRef","database","uploadTask","uploadState","percentUploaded","message","channel","props","currentChannel","user","currentUser","loading","errors","modal","emojiPicker","openModal","setState","closeModal","handleChange","event","target","name","value","handleKeyDown","keyCode","sendMessage","child","id","uid","set","displayName","remove","handleTogglePicker","handleAddEmoji","emoji","oldMessage","newMessage","colonToUnicode","colons","setTimeout","messageInputRef","focus","replace","x","emojis","unicode","native","createMessage","fileUrl","timestamp","ServerValue","TIMESTAMP","avatar","photoURL","getMessagesRef","push","then","catch","err","console","error","concat","getPath","isPrivateChannel","uploadFile","file","metadata","pathToUpload","filePath","put","on","snap","Math","round","bytesTransferred","totalBytes","snapshot","getDownloadURL","downloadUrl","sendFileMessage","cancel","node","marginBottom","some","includes","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport uuidv4 from \"uuid/v4\";\nimport firebase from \"../../firebase\";\nimport { Segment, Button, Input } from \"semantic-ui-react\";\nimport { Picker, emojiIndex } from \"emoji-mart\";\nimport \"emoji-mart/css/emoji-mart.css\";\n\nimport FileModal from \"./FileModal\";\nimport ProgressBar from \"./ProgressBar\";\n\nclass MessageForm extends React.Component {\n  state = {\n    storageRef: firebase.storage().ref(),\n    typingRef: firebase.database().ref(\"typing\"),\n    uploadTask: null,\n    uploadState: \"\",\n    percentUploaded: 0,\n    message: \"\",\n    channel: this.props.currentChannel,\n    user: this.props.currentUser,\n    loading: false,\n    errors: [],\n    modal: false,\n    emojiPicker: false\n  };\n\n  componentWillUnmount() {\n    if(this.state.uploadTask !== null) {\n      this.state.uploadTask.cancel();\n      this.setState({ uploadTask: null });\n    }\n  }\n\n  openModal = () => this.setState({ modal: true });\n\n  closeModal = () => this.setState({ modal: false });\n\n  handleChange = event => {\n    this.setState({ [event.target.name]: event.target.value });\n  };\n\n  handleKeyDown = event => {\n    if(event.keyCode === 13) {\n      this.sendMessage();\n    }\n\n    const { message, typingRef, channel, user } = this.state;\n\n    if (message) {\n      typingRef\n        .child(channel.id)\n        .child(user.uid)\n        .set(user.displayName);\n    } else {\n      typingRef\n        .child(channel.id)\n        .child(user.uid)\n        .remove();\n    }\n  };\n\n  handleTogglePicker = () => {\n    this.setState({ emojiPicker: !this.state.emojiPicker });\n  }\n\n  handleAddEmoji = emoji => {\n    const oldMessage = this.state.message;\n    const newMessage = this.colonToUnicode(`${oldMessage} ${emoji.colons}`);\n    this.setState({ message: newMessage, emojiPicker: false });\n    setTimeout (() => this.messageInputRef.focus(), 0);\n  }\n\n  colonToUnicode = message => {\n    return message.replace(/:[A-Za-z0-9_+-]+:/g, x => {\n      x = x.replace(/:/g, \"\");\n      let emoji = emojiIndex.emojis[x];\n      if( typeof emoji !== \"undefined\") {\n        let unicode = emoji.native;\n        if(typeof unicode !== \"undefined\"){\n          return unicode;\n        }\n      }\n      x = \":\" + x + \":\";\n    });\n  };\n\n  createMessage = (fileUrl = null) => {\n    const message = {\n      timestamp: firebase.database.ServerValue.TIMESTAMP,\n      user: {\n        id: this.state.user.uid,\n        name: this.state.user.displayName,\n        avatar: this.state.user.photoURL\n      }\n    };\n    if (fileUrl !== null) {\n      message[\"image\"] = fileUrl;\n    } else {\n      message[\"content\"] = this.state.message;\n    }\n    return message;\n  };\n\n  sendMessage = () => {\n    const { getMessagesRef } = this.props;\n    const { message, channel, user, typingRef } = this.state;\n\n    if (message) {\n      this.setState({ loading: true });\n      getMessagesRef()\n        .child(channel.id)\n        .push()\n        .set(this.createMessage())\n        .then(() => {\n          this.setState({ loading: false, message: \"\", errors: [] });\n          typingRef\n            .child(channel.id)\n            .child(user.uid)\n            .remove();\n        })\n        .catch(err => {\n          console.error(err);\n          this.setState({\n            loading: false,\n            errors: this.state.errors.concat(err)\n          });\n        });\n    } else {\n      this.setState({\n        errors: this.state.errors.concat({ message: \"Add a message\" })\n      });\n    }\n  };\n\n  getPath = () => {\n    if (this.props.isPrivateChannel) {\n      return `chat/private/${this.state.channel.id}`;\n    } else {\n      return \"chat/public\";\n    }\n  };\n\n  uploadFile = (file, metadata) => {\n    const pathToUpload = this.state.channel.id;\n    const ref = this.props.getMessagesRef();\n    const filePath = `${this.getPath()}/${uuidv4()}.jpg`;\n\n    this.setState(\n      {\n        uploadState: \"uploading\",\n        uploadTask: this.state.storageRef.child(filePath).put(file, metadata)\n      },\n      () => {\n        this.state.uploadTask.on(\n          \"state_changed\",\n          snap => {\n            const percentUploaded = Math.round(\n              (snap.bytesTransferred / snap.totalBytes) * 100\n            );\n            this.setState({ percentUploaded });\n          },\n          err => {\n            console.error(err);\n            this.setState({\n              errors: this.state.errors.concat(err),\n              uploadState: \"error\",\n              uploadTask: null\n            });\n          },\n          () => {\n            this.state.uploadTask.snapshot.ref\n              .getDownloadURL()\n              .then(downloadUrl => {\n                this.sendFileMessage(downloadUrl, ref, pathToUpload);\n              })\n              .catch(err => {\n                console.error(err);\n                this.setState({\n                  errors: this.state.errors.concat(err),\n                  uploadState: \"error\",\n                  uploadTask: null\n                });\n              });\n          }\n        );\n      }\n    );\n  };\n\n  sendFileMessage = (fileUrl, ref, pathToUpload) => {\n    ref\n      .child(pathToUpload)\n      .push()\n      .set(this.createMessage(fileUrl))\n      .then(() => {\n        this.setState({ uploadState: \"done\" });\n      })\n      .catch(err => {\n        console.error(err);\n        this.setState({\n          errors: this.state.errors.concat(err)\n        });\n      });\n  };\n\n  render() {\n    // prettier-ignore\n    const { errors, message, loading, modal, uploadState, percentUploaded,\n    emojiPicker } = this.state;\n\n    return (\n      <Segment className=\"message__form\">\n        {emojiPicker && (\n          <Picker \n            set=\"apple\"\n            onSelect={this.handleAddEmoji}\n            className=\"emojiPIcker\"\n            title=\"Pick your emoji\"\n            emoji=\"point_up\"\n          />\n        )}\n        <Input\n          fluid\n          name=\"message\"\n          onChange={this.handleChange}\n          onKeyDown={this.handleKeyDown}\n          value={message}\n          ref={node => (this.messageInputRef = node)}\n          style={{ marginBottom: \"0.7em\" }}\n          label={\n            <Button \n              icon={emojiPicker ? \"close\" : \"add\"} \n              content={emojiPicker ? \"close\" : null}\n              onClick={this.handleTogglePicker}\n            />}          \n          labelPosition=\"left\"\n          className={\n            errors.some(error => error.message.includes(\"message\"))\n              ? \"error\"\n              : \"\"\n          }\n          placeholder=\"Write your message\"\n        />\n        <Button.Group icon widths=\"2\">\n          <Button\n            onClick={this.sendMessage}\n            disabled={loading}\n            color=\"orange\"\n            content=\"Add Reply\"\n            labelPosition=\"left\"\n            icon=\"edit\"\n          />\n          <Button\n            color=\"teal\"\n            disabled={uploadState === \"uploading\"}\n            onClick={this.openModal}\n            content=\"Upload Media\"\n            labelPosition=\"right\"\n            icon=\"cloud upload\"\n          />\n        </Button.Group>\n        <FileModal\n          modal={modal}\n          closeModal={this.closeModal}\n          uploadFile={this.uploadFile}\n        />\n        <ProgressBar\n          uploadState={uploadState}\n          percentUploaded={percentUploaded}\n        />\n      </Segment>\n    );\n  }\n}\n\nexport default MessageForm;\n"]},"metadata":{},"sourceType":"module"}